<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Juego de Memoria - AlfaIA</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #667eea;
            --secondary: #764ba2;
            --success: #42e695;
            --warning: #f093fb;
            --info: #4facfe;
            --danger: #ff6b6b;
        }

        body {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .navbar-custom {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
        }

        .game-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 2rem;
            margin: 2rem 0;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .game-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin: 2rem 0;
            text-align: center;
        }

        .stat-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary);
        }

        .stat-label {
            color: #6c757d;
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }

        .timer-container {
            text-align: center;
            margin: 1.5rem 0;
        }

        .timer-circle {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--info), var(--primary));
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            font-weight: bold;
            margin: 0 auto;
            transition: all 0.3s ease;
        }

        .timer-circle.warning {
            background: linear-gradient(135deg, var(--warning), var(--danger));
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .memory-grid {
            display: grid;
            gap: 1rem;
            margin: 2rem 0;
            justify-content: center;
        }

        .grid-12 { grid-template-columns: repeat(4, 1fr); }
        .grid-16 { grid-template-columns: repeat(4, 1fr); }
        .grid-20 { grid-template-columns: repeat(5, 1fr); }
        .grid-24 { grid-template-columns: repeat(6, 1fr); }

        .memory-card {
            width: 120px;
            height: 120px;
            background: linear-gradient(135deg, #f8f9fa, #dee2e6);
            border: 2px solid #e9ecef;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            perspective: 1000px;
            position: relative;
            transform-style: preserve-3d;
        }

        .memory-card:hover:not(.matched):not(.flipped) {
            transform: translateY(-5px) rotate(2deg);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
            border-color: var(--primary);
        }

        .memory-card.flipped {
            background: linear-gradient(135deg, var(--info), var(--primary));
            color: white;
        }

        .memory-card.matched {
            background: linear-gradient(135deg, var(--success), #38a169);
            color: white;
            animation: matchFound 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            cursor: default;
            box-shadow: 0 8px 25px rgba(66, 230, 149, 0.4);
        }

        .card-inner {
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.6s;
            transform-style: preserve-3d;
            position: relative;
        }

        .memory-card.flipped .card-inner {
            transform: rotateY(180deg);
        }

        .card-front, .card-back-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 13px;
        }

        .card-back-face {
            transform: rotateY(180deg);
            background: linear-gradient(135deg, var(--info), var(--primary));
            color: white;
        }

        .card-content {
            font-size: 1.1rem;
            font-weight: 600;
            text-align: center;
            padding: 0.5rem;
            line-height: 1.2;
        }

        .card-back {
            font-size: 2rem;
            color: var(--primary);
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.8);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        @keyframes matchFound {
            0% { transform: scale(1); }
            50% { transform: scale(1.2) rotate(5deg); }
            100% { transform: scale(1); }
        }

        @keyframes matchSuccess {
            0% { transform: scale(1); }
            25% { transform: scale(1.1) rotate(-5deg); }
            50% { transform: scale(1.2) rotate(5deg); }
            75% { transform: scale(1.1) rotate(-2deg); }
            100% { transform: scale(1) rotate(0deg); }
        }

        @keyframes shakeError {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }

        @keyframes particleExplode {
            0% {
                transform: translate(0, 0) scale(1);
                opacity: 1;
            }
            100% {
                transform: translate(
                    calc(cos(var(--angle)) * var(--distance)),
                    calc(sin(var(--angle)) * var(--distance))
                ) scale(0);
                opacity: 0;
            }
        }

        .game-complete {
            display: none;
            text-align: center;
            background: linear-gradient(135deg, var(--success), #38a169);
            color: white;
            border-radius: 20px;
            padding: 3rem 2rem;
            margin: 2rem 0;
            box-shadow: 0 10px 30px rgba(66, 230, 149, 0.3);
        }

        .final-score {
            font-size: 4rem;
            font-weight: bold;
            margin: 1rem 0;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .btn-modern {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border: none;
            color: white;
            padding: 0.75rem 2rem;
            border-radius: 50px;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-modern:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
            color: white;
            text-decoration: none;
        }

        .btn-secondary-modern {
            background: linear-gradient(135deg, #6c757d, #495057);
        }

        .btn-warning-modern {
            background: linear-gradient(135deg, #ffc107, #ff8500);
        }

        .btn-info-modern {
            background: linear-gradient(135deg, var(--info), #0056b3);
        }

        .progress-bar-custom {
            height: 8px;
            border-radius: 50px;
            background: linear-gradient(90deg, var(--info), var(--success));
        }

        .spark {
            position: absolute;
            width: 4px;
            height: 4px;
            background: #ffd700;
            border-radius: 50%;
            pointer-events: none;
            animation: sparkle 0.6s ease-out forwards;
        }

        @keyframes sparkle {
            0% {
                transform: scale(0) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: scale(1) rotate(180deg) translate(20px, -20px);
                opacity: 0;
            }
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        .logro-popup {
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            border-left: 5px solid #28a745;
        }

        @media (max-width: 768px) {
            .memory-card {
                width: 80px;
                height: 80px;
                font-size: 0.9rem;
            }

            .game-container {
                margin: 1rem;
                padding: 1rem;
            }

            .timer-circle {
                width: 80px;
                height: 80px;
                font-size: 1.5rem;
            }

            .final-score {
                font-size: 2.5rem;
            }

            .grid-12, .grid-16 { grid-template-columns: repeat(3, 1fr); }
            .grid-20, .grid-24 { grid-template-columns: repeat(4, 1fr); }
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-custom">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('index') }}">
                <i class="fas fa-graduation-cap me-2"></i>AlfaIA
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="{{ url_for('dashboard') }}">Dashboard</a>
                <a class="nav-link" href="{{ url_for('juegos') }}">Juegos</a>
                <a class="nav-link" href="{{ url_for('mostrar_progreso') }}">Progreso</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="game-container">
                    <!-- Header del juego -->
                    <div class="text-center mb-4">
                        <h2><i class="fas fa-brain me-2"></i>Juego de Memoria</h2>
                        <p class="text-muted">Encuentra las parejas de palabras sin√≥nimas</p>
                        <span class="badge bg-primary fs-6">Nivel {{ nivel if nivel is defined else 1 }}</span>
                        <span class="badge bg-success fs-6">{{ puntos_maximos if puntos_maximos is defined else 'Variable' }} puntos m√°ximos</span>
                    </div>

                    <!-- Estad√≠sticas del juego -->
                    <div class="game-stats">
                        <div class="stat-card">
                            <div class="stat-number" id="paresEncontrados">0</div>
                            <div class="stat-label">Pares Encontrados</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="intentos">0</div>
                            <div class="stat-label">Intentos</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="precision">100</div>
                            <div class="stat-label">Precisi√≥n (%)</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="puntos">0</div>
                            <div class="stat-label">Puntos</div>
                        </div>
                    </div>

                    <!-- Temporizador -->
                    <div class="timer-container">
                        <div class="timer-circle" id="timerContainer">
                            <span id="tiempoRestante">{{ tiempo_limite if tiempo_limite is defined else 60 }}</span>
                        </div>
                        <p class="text-muted mt-2">segundos restantes</p>
                    </div>

                    <!-- Barra de progreso -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Progreso del juego</span>
                            <span id="progressText">0%</span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar progress-bar-custom" id="progressBar" role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>

                    <!-- Grid de cartas -->
                    <div class="memory-grid" id="memoryGrid">
                        <!-- Las cartas se generan din√°micamente con JavaScript -->
                    </div>

                    <!-- Secci√≥n de juego completado -->
                    <div class="game-complete" id="gameComplete">
                        <h3><i class="fas fa-trophy me-2"></i>¬°Juego Completado!</h3>
                        <div class="final-score" id="finalScore">0</div>
                        <p id="gameMessage">¬°Excelente trabajo!</p>

                        <div class="row text-center mt-4">
                            <div class="col-md-4">
                                <h5 id="finalTime">0:00</h5>
                                <small>Tiempo empleado</small>
                            </div>
                            <div class="col-md-4">
                                <h5 id="finalPrecision">100%</h5>
                                <small>Precisi√≥n final</small>
                            </div>
                            <div class="col-md-4">
                                <h5 id="finalAttempts">0</h5>
                                <small>Intentos totales</small>
                            </div>
                        </div>

                        <div class="mt-4">
                            <button class="btn-modern me-3" onclick="nuevoJuego()">
                                <i class="fas fa-redo"></i> Nuevo Juego
                            </button>
                            <button class="btn-modern btn-secondary-modern" onclick="volverMenu()">
                                <i class="fas fa-home"></i> Men√∫ Principal
                            </button>
                        </div>
                    </div>

                    <!-- Botones de acci√≥n -->
                    <div class="text-center mt-4" id="gameButtons">
                        <button class="btn-modern btn-warning-modern me-3" onclick="reiniciarJuego()">
                            <i class="fas fa-refresh"></i> Reiniciar
                        </button>
                        <button class="btn-modern btn-secondary-modern me-3" onclick="pausarJuego()">
                            <i class="fas fa-pause"></i> <span id="pauseText">Pausar</span>
                        </button>
                        <button class="btn-modern btn-secondary-modern" onclick="volverMenu()">
                            <i class="fas fa-home"></i> Men√∫ Principal
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Datos del juego
        const gameData = {
            pairs: {% if pares is defined %}{{ pares | tojsonfilter }}{% else %}[
                ["Grande", "Enorme"],
                ["Peque√±o", "Chico"],
                ["Bonito", "Hermoso"],
                ["R√°pido", "Veloz"],
                ["Feliz", "Alegre"],
                ["Triste", "Melanc√≥lico"]
            ]{% endif %},
            timeLimit: {{ tiempo_limite if tiempo_limite is defined else 60 }},
            level: {{ nivel if nivel is defined else 1 }},
            maxPoints: {{ puntos_maximos if puntos_maximos is defined else 120 }}
        };

        // Variables del juego
        let cartaVolteada = null;
        let bloqueado = false;
        let paresEncontrados = 0;
        let intentos = 0;
        let tiempoRestante = gameData.timeLimit;
        let temporizador;
        let juegoTerminado = false;
        let juegoPausado = false;
        let tiempoInicio;
        let puntos = 0;
        let cartas = [];

        // Inicializar el juego
        function inicializarJuego() {
            generarCartas();
            tiempoInicio = Date.now();
            iniciarTemporizador();
            actualizarEstadisticas();

            // Agregar estilos para animaciones si no existen
            if (!document.getElementById('logroStyles')) {
                const styles = document.createElement('style');
                styles.id = 'logroStyles';
                styles.textContent = `
                    @keyframes slideInRight {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                    @keyframes slideOutRight {
                        from { transform: translateX(0); opacity: 1; }
                        to { transform: translateX(100%); opacity: 0; }
                    }
                    .logro-popup { box-shadow: 0 10px 30px rgba(0,0,0,0.3); border-left: 5px solid #28a745; }
                `;
                document.head.appendChild(styles);
            }
        }

        // Generar cartas mejorado
        function generarCartas() {
            const grid = document.getElementById('memoryGrid');
            grid.innerHTML = '';

            // Crear array de cartas
            cartas = [];
            gameData.pairs.forEach((par, index) => {
                cartas.push({id: index * 2, texto: par[0], par: index, tipo: 'primera'});
                cartas.push({id: index * 2 + 1, texto: par[1], par: index, tipo: 'segunda'});
            });

            // Mezclar cartas usando algoritmo Fisher-Yates
            for (let i = cartas.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [cartas[i], cartas[j]] = [cartas[j], cartas[i]];
            }

            // Ajustar grid seg√∫n n√∫mero de cartas
            const numCartas = cartas.length;
            let columnas = 4;
            if (numCartas <= 12) columnas = 4;
            else if (numCartas <= 16) columnas = 4;
            else if (numCartas <= 20) columnas = 5;
            else columnas = 6;

            grid.style.gridTemplateColumns = `repeat(${columnas}, 1fr)`;
            grid.className = `memory-grid grid-${numCartas}`;

            // Crear elementos HTML con mejor estructura
            cartas.forEach((carta, index) => {
                const cardElement = document.createElement('div');
                cardElement.className = 'memory-card';
                cardElement.dataset.id = carta.id;
                cardElement.dataset.par = carta.par;
                cardElement.dataset.index = index;
                cardElement.innerHTML = `
                    <div class="card-inner">
                        <div class="card-front">
                            <div class="card-back"><i class="fas fa-question"></i></div>
                        </div>
                        <div class="card-back-face">
                            <div class="card-content">${carta.texto}</div>
                        </div>
                    </div>
                `;
                cardElement.addEventListener('click', () => voltearCarta(cardElement));

                // Agregar animaci√≥n de entrada
                cardElement.style.animationDelay = `${index * 0.1}s`;
                cardElement.style.animation = 'fadeInUp 0.6s ease-out forwards';

                grid.appendChild(cardElement);
            });
        }

        // Voltear carta mejorado
        function voltearCarta(carta) {
            if (bloqueado || carta.classList.contains('flipped') || carta.classList.contains('matched') || juegoPausado || juegoTerminado) {
                return;
            }

            // Crear efecto de chispas
            const rect = carta.getBoundingClientRect();
            const x = rect.left + rect.width / 2;
            const y = rect.top + rect.height / 2;
            crearChispas(x, y);

            // Animaci√≥n de volteo
            carta.classList.add('flipped');
            carta.style.transform = 'rotateY(180deg)';

            // Sonido de carta volteada (opcional)
            reproducirSonido('flip');

            if (!cartaVolteada) {
                cartaVolteada = carta;
            } else {
                bloqueado = true;
                intentos++;
                actualizarEstadisticas();

                if (carta.dataset.par === cartaVolteada.dataset.par) {
                    // Es una pareja
                    setTimeout(() => {
                        encontrarPar();
                    }, 600);
                } else {
                    // No es pareja
                    setTimeout(() => {
                        ocultarCartas();
                    }, 1200);
                }
            }
        }

        // Encontrar par mejorado
        function encontrarPar() {
            const carta1 = cartaVolteada;
            const carta2 = document.querySelector('.flipped:not(.matched)');

            if (carta1 && carta2) {
                carta1.classList.add('matched');
                carta2.classList.add('matched');

                // Animaci√≥n de √©xito
                carta1.style.animation = 'matchSuccess 0.8s ease-out';
                carta2.style.animation = 'matchSuccess 0.8s ease-out';

                // Efecto de part√≠culas
                crearParticulasExito(carta1);
                crearParticulasExito(carta2);

                reproducirSonido('match');
            }

            paresEncontrados++;

            // Calcular puntos con sistema mejorado
            let puntosGanados = 20; // Puntos base

            // Bonus por velocidad
            const tiempoTranscurrido = gameData.timeLimit - tiempoRestante;
            if (tiempoTranscurrido < 30) puntosGanados += 15; // Bonus velocidad
            else if (tiempoTranscurrido < 45) puntosGanados += 10;
            else if (tiempoTranscurrido < 60) puntosGanados += 5;

            // Bonus por eficiencia
            const eficiencia = (paresEncontrados * 2) / intentos;
            if (eficiencia >= 0.9) puntosGanados += 20; // Muy eficiente
            else if (eficiencia >= 0.8) puntosGanados += 15;
            else if (eficiencia >= 0.7) puntosGanados += 10;

            // Bonus por nivel
            puntosGanados += (gameData.level - 1) * 5;

            puntos += puntosGanados;

            actualizarEstadisticas();
            resetearCartas();

            // Verificar si el juego termin√≥
            if (paresEncontrados === gameData.pairs.length) {
                setTimeout(() => {
                    finalizarJuego();
                }, 800);
            }
        }

        // Crear part√≠culas de √©xito
        function crearParticulasExito(carta) {
            const rect = carta.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;

            for (let i = 0; i < 12; i++) {
                setTimeout(() => {
                    const particula = document.createElement('div');
                    particula.style.cssText = `
                        position: fixed;
                        left: ${centerX}px;
                        top: ${centerY}px;
                        width: 6px;
                        height: 6px;
                        background: linear-gradient(45deg, #ffd700, #ff8c00);
                        border-radius: 50%;
                        pointer-events: none;
                        z-index: 9999;
                        animation: particleExplode 1s ease-out forwards;
                    `;

                    // Direcci√≥n aleatoria
                    const angle = (i * 30) + Math.random() * 30;
                    const distance = 50 + Math.random() * 50;
                    particula.style.setProperty('--angle', angle + 'deg');
                    particula.style.setProperty('--distance', distance + 'px');

                    document.body.appendChild(particula);

                    setTimeout(() => {
                        if (particula.parentNode) {
                            particula.parentNode.removeChild(particula);
                        }
                    }, 1000);
                }, i * 50);
            }
        }

        // Ocultar cartas mejorado
        function ocultarCartas() {
            const cartasVolteadas = document.querySelectorAll('.flipped:not(.matched)');

            reproducirSonido('error');

            // Animaci√≥n de error
            cartasVolteadas.forEach(carta => {
                carta.style.animation = 'shakeError 0.5s ease-out';
                setTimeout(() => {
                    carta.classList.remove('flipped');
                    carta.style.transform = 'rotateY(0deg)';
                    carta.style.animation = '';
                }, 500);
            });

            setTimeout(resetearCartas, 600);
        }

        // Resetear cartas
        function resetearCartas() {
            cartaVolteada = null;
            bloqueado = false;
        }

        // Sistema de sonidos mejorado
        function reproducirSonido(tipo) {
            // Usar Web Audio API para sonidos
            if (typeof AudioContext !== 'undefined' || typeof webkitAudioContext !== 'undefined') {
                const audioContext = new (AudioContext || webkitAudioContext)();

                let frequency, duration;

                switch(tipo) {
                    case 'flip':
                        frequency = 800;
                        duration = 0.1;
                        break;
                    case 'match':
                        frequency = 1200;
                        duration = 0.3;
                        break;
                    case 'error':
                        frequency = 300;
                        duration = 0.2;
                        break;
                    case 'win':
                        // Melod√≠a de victoria
                        [659, 659, 659, 523, 659, 784].forEach((freq, i) => {
                            setTimeout(() => {
                                playTone(audioContext, freq, 0.2);
                            }, i * 200);
                        });
                        return;
                    default:
                        return;
                }

                playTone(audioContext, frequency, duration);
            }
        }

        function playTone(audioContext, frequency, duration) {
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.frequency.value = frequency;
            oscillator.type = 'sine';

            gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);

            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + duration);
        }

        // Iniciar temporizador
        function iniciarTemporizador() {
            temporizador = setInterval(() => {
                if (!juegoPausado && !juegoTerminado) {
                    tiempoRestante--;
                    actualizarTemporizador();

                    if (tiempoRestante <= 0) {
                        finalizarJuego();
                    }
                }
            }, 1000);
        }

        // Actualizar temporizador
        function actualizarTemporizador() {
            document.getElementById('tiempoRestante').textContent = tiempoRestante;
            const timerContainer = document.getElementById('timerContainer');

            if (tiempoRestante <= 10) {
                timerContainer.classList.add('warning');
            } else {
                timerContainer.classList.remove('warning');
            }
        }

        // Actualizar estad√≠sticas
        function actualizarEstadisticas() {
            document.getElementById('paresEncontrados').textContent = paresEncontrados;
            document.getElementById('intentos').textContent = intentos;
            document.getElementById('puntos').textContent = puntos;

            const precision = intentos === 0 ? 100 : ((paresEncontrados * 2) / intentos * 100);
            document.getElementById('precision').textContent = Math.round(precision);

            // Actualizar barra de progreso
            const progreso = (paresEncontrados / gameData.pairs.length) * 100;
            document.getElementById('progressBar').style.width = progreso + '%';
            document.getElementById('progressText').textContent = Math.round(progreso) + '%';
        }

        // Finalizar juego
        function finalizarJuego() {
            juegoTerminado = true;
            clearInterval(temporizador);

            const tiempoFinal = Date.now();
            const tiempoEmpleadoSegundos = Math.floor((tiempoFinal - tiempoInicio) / 1000);

            // Calcular estad√≠sticas finales
            const precision = intentos === 0 ? 100 : ((paresEncontrados * 2) / intentos * 100);
            const errores = intentos - (paresEncontrados * 2);

            // Calcular puntos finales
            let puntosFinales = puntos;

            // Bonus por tiempo sobrante
            if (tiempoRestante > 0) {
                const bonusTiempo = Math.floor(tiempoRestante / 5);
                puntosFinales += bonusTiempo;
            }

            // Bonus por precisi√≥n perfecta
            if (errores === 0 && paresEncontrados === gameData.pairs.length) {
                puntosFinales += 50; // Gran bonus por juego perfecto
            }

            // Mostrar resultados en pantalla
            document.getElementById('gameComplete').style.display = 'block';
            document.getElementById('gameButtons').style.display = 'none';

            document.getElementById('finalScore').textContent = puntosFinales;
            document.getElementById('finalTime').textContent = formatearTiempo(tiempoEmpleadoSegundos);
            document.getElementById('finalPrecision').textContent = `${precision.toFixed(1)}%`;
            document.getElementById('finalAttempts').textContent = intentos;

            // Mensaje seg√∫n rendimiento
            let mensaje = '';
            if (precision === 100 && errores === 0) {
                mensaje = '¬°PERFECTO! üèÜ ¬°No cometiste ning√∫n error!';
            } else if (precision >= 80) {
                mensaje = '¬°Excelente trabajo! üåü Muy buena memoria.';
            } else if (precision >= 60) {
                mensaje = '¬°Bien hecho! üëç Sigue practicando.';
            } else {
                mensaje = '¬°Buen intento! üí™ La pr√°ctica hace al maestro.';
            }
            document.getElementById('gameMessage').textContent = mensaje;

            // Verificar logros
            setTimeout(() => {
                verificarLogros(precision, errores, tiempoEmpleadoSegundos);
            }, 1000);

            // Guardar resultado en base de datos
            guardarResultadoEnBD(puntosFinales, precision, tiempoEmpleadoSegundos, errores);
        }

        // Formatear tiempo
        function formatearTiempo(segundos) {
            const minutos = Math.floor(segundos / 60);
            const segs = segundos % 60;
            return `${minutos}:${segs.toString().padStart(2, '0')}`;
        }

        // Guardar resultado en base de datos
        function guardarResultadoEnBD(puntos, precision, tiempoSegundos, errores) {
            const datosJuego = {
                tipo: 'memoria',
                nombre: 'Juego de Memoria',
                puntos: puntos,
                precision: precision,
                tiempo_segundos: tiempoSegundos,
                datos_adicionales: {
                    pares_encontrados: paresEncontrados,
                    total_pares: gameData.pairs.length,
                    intentos: intentos,
                    errores: errores,
                    nivel: gameData.level,
                    tiempo_limite: gameData.timeLimit,
                    tiempo_sobrante: tiempoRestante,
                    velocidad_promedio: tiempoSegundos / paresEncontrados || 0
                }
            };

            fetch('/api/ejercicios/completar', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(datosJuego)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('Resultado guardado exitosamente:', data);

                    // Mostrar mensaje de √©xito
                    const mensajeExito = document.createElement('div');
                    mensajeExito.className = 'alert alert-success mt-3';
                    mensajeExito.innerHTML = `
                        <i class="fas fa-check-circle me-2"></i>
                        <strong>¬°Resultado guardado!</strong><br>
                        ${data.message}<br>
                        <small>Puntos totales: ${data.data?.nuevo_total_puntos || puntos}</small>
                    `;
                    document.getElementById('gameComplete').appendChild(mensajeExito);

                    // Agregar bot√≥n para ver progreso
                    const botonProgreso = document.createElement('button');
                    botonProgreso.className = 'btn-modern btn-info-modern mt-2';
                    botonProgreso.innerHTML = '<i class="fas fa-chart-line me-2"></i>Ver Mi Progreso';
                    botonProgreso.onclick = () => window.location.href = '/progreso';
                    document.getElementById('gameComplete').appendChild(botonProgreso);

                } else {
                    console.error('Error guardando resultado:', data.message);

                    const mensajeError = document.createElement('div');
                    mensajeError.className = 'alert alert-warning mt-3';
                    mensajeError.innerHTML = `
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <small>No se pudo guardar en la base de datos, pero el juego se complet√≥.</small>
                    `;
                    document.getElementById('gameComplete').appendChild(mensajeError);
                }
            })
            .catch(error => {
                console.error('Error en la petici√≥n:', error);

                const mensajeError = document.createElement('div');
                mensajeError.className = 'alert alert-danger mt-3';
                mensajeError.innerHTML = `
                    <i class="fas fa-wifi me-2"></i>
                    <small>Error de conexi√≥n. El resultado no se pudo guardar.</small>
                `;
                document.getElementById('gameComplete').appendChild(mensajeError);
            });
        }

        // Verificar logros
        function verificarLogros(precision, errores, tiempoSegundos) {
            const logros = [];

            // Logro: Primera victoria
            if (paresEncontrados === gameData.pairs.length) {
                logros.push({
                    nombre: 'Primera Victoria',
                    descripcion: 'Completaste tu primer juego de memoria',
                    icono: 'üèÜ'
                });
            }

            // Logro: Memoria perfecta
            if (errores === 0 && paresEncontrados === gameData.pairs.length) {
                logros.push({
                    nombre: 'Memoria Perfecta',
                    descripcion: 'Encontraste todos los pares sin errores',
                    icono: 'üß†'
                });
            }

            // Logro: Velocidad rel√°mpago
            if (tiempoSegundos <= 30 && paresEncontrados === gameData.pairs.length) {
                logros.push({
                    nombre: 'Rel√°mpago',
                    descripcion: 'Completaste el juego en menos de 30 segundos',
                    icono: '‚ö°'
                });
            }

            // Logro: Eficiencia m√°xima
            if (intentos === paresEncontrados * 2) {
                logros.push({
                    nombre: 'Eficiencia M√°xima',
                    descripcion: 'Encontraste cada par en el primer intento',
                    icono: 'üéØ'
                });
            }

            // Mostrar logros conseguidos
            if (logros.length > 0) {
                mostrarLogrosConseguidos(logros);
            }
        }

        // Mostrar logros conseguidos
        function mostrarLogrosConseguidos(logros) {
            logros.forEach((logro, index) => {
                setTimeout(() => {
                    const logroElement = document.createElement('div');
                    logroElement.className = 'alert alert-success logro-popup';
                    logroElement.style.cssText = `
                        position: fixed;
                        top: ${100 + (index * 80)}px;
                        right: 20px;
                        z-index: 10000;
                        min-width: 300px;
                        animation: slideInRight 0.5s ease-out;
                    `;
                    logroElement.innerHTML = `
                        <div class="d-flex align-items-center">
                            <div class="me-3" style="font-size: 2rem;">${logro.icono}</div>
                            <div>
                                <strong>¬°Logro Desbloqueado!</strong><br>
                                <span class="fw-bold">${logro.nombre}</span><br>
                                <small>${logro.descripcion}</small>
                            </div>
                        </div>
                    `;

                    document.body.appendChild(logroElement);

                    // Remover despu√©s de 4 segundos
                    setTimeout(() => {
                        logroElement.style.animation = 'slideOutRight 0.5s ease-in';
                        setTimeout(() => {
                            if (logroElement.parentNode) {
                                logroElement.parentNode.removeChild(logroElement);
                            }
                        }, 500);
                    }, 4000);

                }, index * 500);
            });
        }

        // Crear efecto de chispas
        function crearChispas(x, y) {
            for (let i = 0; i < 6; i++) {
                setTimeout(() => {
                    const chispa = document.createElement('div');
                    chispa.className = 'spark';
                    chispa.style.left = x + 'px';
                    chispa.style.top = y + 'px';
                    document.body.appendChild(chispa);

                    setTimeout(() => {
                        if (chispa.parentNode) {
                            chispa.parentNode.removeChild(chispa);
                        }
                    }, 600);
                }, i * 50);
            }
        }

        // Pausar/reanudar juego
        function pausarJuego() {
            if (juegoTerminado) return;

            juegoPausado = !juegoPausado;
            const pauseText = document.getElementById('pauseText');

            if (juegoPausado) {
                clearInterval(temporizador);
                pauseText.textContent = 'Reanudar';

                // Ocultar cartas volteadas temporalmente
                const cartasVolteadas = document.querySelectorAll('.memory-card.flipped:not(.matched)');
                cartasVolteadas.forEach(carta => {
                    carta.style.filter = 'blur(5px)';
                });

                // Mostrar overlay de pausa
                const pauseOverlay = document.createElement('div');
                pauseOverlay.id = 'pauseOverlay';
                pauseOverlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.8);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 9999;
                    color: white;
                    font-size: 2rem;
                `;
                pauseOverlay.innerHTML = `
                    <div class="text-center">
                        <i class="fas fa-pause-circle mb-3"></i>
                        <div>Juego Pausado</div>
                        <small style="font-size: 1rem;">Haz clic en "Reanudar" para continuar</small>
                    </div>
                `;
                document.body.appendChild(pauseOverlay);

            } else {
                pauseText.textContent = 'Pausar';

                // Restaurar cartas
                const cartasVolteadas = document.querySelectorAll('.memory-card.flipped:not(.matched)');
                cartasVolteadas.forEach(carta => {
                    carta.style.filter = 'none';
                });

                // Quitar overlay de pausa
                const pauseOverlay = document.getElementById('pauseOverlay');
                if (pauseOverlay) {
                    pauseOverlay.remove();
                }

                iniciarTemporizador();
            }
        }

        // Reiniciar juego
        function reiniciarJuego() {
            if (confirm('¬øEst√°s seguro de que quieres reiniciar? Se perder√° el progreso actual.')) {
                // Reiniciar variables
                cartaVolteada = null;
                bloqueado = false;
                paresEncontrados = 0;
                intentos = 0;
                tiempoRestante = gameData.timeLimit;
                juegoTerminado = false;
                juegoPausado = false;
                puntos = 0;

                // Limpiar temporizador
                clearInterval(temporizador);

                // Restaurar interfaz
                document.getElementById('gameComplete').style.display = 'none';
                document.getElementById('gameButtons').style.display = 'block';
                document.getElementById('pauseText').textContent = 'Pausar';

                // Quitar overlay de pausa si existe
                const pauseOverlay = document.getElementById('pauseOverlay');
                if (pauseOverlay) {
                    pauseOverlay.remove();
                }

                // Reinicializar juego
                inicializarJuego();
            }
        }

        // Nuevo juego con nuevas palabras
        function nuevoJuego() {
            // Generar nuevas parejas aleatorias
            const todasLasParejas = [
                ["Grande", "Enorme"], ["Peque√±o", "Chico"], ["Bonito", "Hermoso"],
                ["R√°pido", "Veloz"], ["Feliz", "Alegre"], ["Triste", "Melanc√≥lico"],
                ["Fuerte", "Robusto"], ["D√©bil", "Fr√°gil"], ["Caliente", "C√°lido"],
                ["Fr√≠o", "Helado"], ["Nuevo", "Moderno"], ["Viejo", "Antiguo"],
                ["Alto", "Elevado"], ["Bajo", "Peque√±o"], ["Ancho", "Amplio"],
                ["Estrecho", "Angosto"], ["Claro", "Brillante"], ["Oscuro", "Tenebroso"],
                ["Dulce", "Sabroso"], ["Amargo", "√Åcido"], ["Limpio", "Aseado"],
                ["Sucio", "Manchado"], ["F√°cil", "Sencillo"], ["Dif√≠cil", "Complicado"]
            ];

            // Seleccionar parejas aleatorias seg√∫n el nivel
            const numPares = Math.min(gameData.pairs.length, todasLasParejas.length);
            gameData.pairs = todasLasParejas.sort(() => 0.5 - Math.random()).slice(0, numPares);

            reiniciarJuego();
        }

        // Volver al men√∫ principal
        function volverMenu() {
            if (juegoTerminado || confirm('¬øEst√°s seguro de que quieres salir del juego?')) {
                window.location.href = '/juegos';
            }
        }

        // Manejar teclas de atajo
        document.addEventListener('keydown', function(event) {
            switch(event.key) {
                case ' ': // Espacio para pausar
                    event.preventDefault();
                    pausarJuego();
                    break;
                case 'r':
                case 'R':
                    if (event.ctrlKey) { // Ctrl+R para reiniciar
                        event.preventDefault();
                        reiniciarJuego();
                    }
                    break;
                case 'h':
                case 'H':
                    if (!juegoTerminado && intentos >= 10 && paresEncontrados === 0) {
                        mostrarSugerencia();
                    }
                    break;
                case 'Escape':
                    volverMenu();
                    break;
            }
        });

        // Mostrar sugerencia (solo despu√©s de muchos intentos sin √©xito)
        function mostrarSugerencia() {
            const cartas = document.querySelectorAll('.memory-card:not(.matched)');
            if (cartas.length >= 2) {
                // Encontrar dos cartas que forman pareja
                for (let i = 0; i < cartas.length; i++) {
                    for (let j = i + 1; j < cartas.length; j++) {
                        if (cartas[i].dataset.par === cartas[j].dataset.par) {
                            // Mostrar brevemente las cartas
                            cartas[i].style.border = '3px solid #f39c12';
                            cartas[j].style.border = '3px solid #f39c12';

                            setTimeout(() => {
                                cartas[i].style.border = 'none';
                                cartas[j].style.border = 'none';
                            }, 2000);

                            // Reducir puntos por usar ayuda
                            puntos = Math.max(0, puntos - 10);
                            actualizarEstadisticas();
                            return;
                        }
                    }
                }
            }
        }

        // Mostrar controles al usuario (solo la primera vez)
        function mostrarControles() {
            const atajos = document.createElement('div');
            atajos.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: rgba(0,0,0,0.9);
                color: white;
                padding: 15px;
                border-radius: 10px;
                font-size: 12px;
                z-index: 1000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            `;
            atajos.innerHTML = `
                <div style="font-weight: bold; margin-bottom: 8px;">‚å®Ô∏è Atajos de Teclado:</div>
                <div>‚Ä¢ Espacio: Pausar/Reanudar</div>
                <div>‚Ä¢ Ctrl+R: Reiniciar juego</div>
                <div>‚Ä¢ H: Sugerencia (despu√©s de 10 intentos)</div>
                <div>‚Ä¢ Esc: Volver al men√∫</div>
            `;
            document.body.appendChild(atajos);

            // Ocultar controles despu√©s de 6 segundos
            setTimeout(() => {
                atajos.style.opacity = '0';
                atajos.style.transition = 'opacity 1s';
                setTimeout(() => {
                    if (atajos.parentNode) {
                        atajos.parentNode.removeChild(atajos);
                    }
                }, 1000);
            }, 6000);
        }

        // Detectar dispositivos m√≥viles
        function esMobile() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }

        // Ajustar interfaz para m√≥viles
        function ajustarParaMobile() {
            if (esMobile()) {
                // Reducir tama√±o de cartas en m√≥viles muy peque√±os
                const cards = document.querySelectorAll('.memory-card');
                cards.forEach(card => {
                    card.style.width = '70px';
                    card.style.height = '70px';
                    card.style.fontSize = '0.8rem';
                });

                // Ajustar grid para pantallas peque√±as
                const grid = document.getElementById('memoryGrid');
                grid.style.gap = '0.5rem';
            }
        }

        // Inicializar cuando se carga la p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üéÆ Inicializando Juego de Memoria v2.0');
            console.log('üìä Configuraci√≥n:', gameData);

            // Ajustar para dispositivos m√≥viles
            ajustarParaMobile();

            // Mostrar controles de teclado (solo en desktop)
            if (!esMobile()) {
                setTimeout(mostrarControles, 2000);
            }

            // Inicializar el juego
            inicializarJuego();

            // Mostrar mensaje de bienvenida
            const bienvenida = document.createElement('div');
            bienvenida.className = 'alert alert-info';
            bienvenida.style.cssText = `
                position: fixed;
                top: 80px;
                left: 50%;
                transform: translateX(-50%);
                z-index: 1000;
                min-width: 300px;
                text-align: center;
            `;
            bienvenida.innerHTML = `
                <i class="fas fa-brain me-2"></i>
                <strong>¬°Bienvenido al Juego de Memoria!</strong><br>
                <small>Encuentra todas las parejas de sin√≥nimos. ¬°Buena suerte!</small>
            `;
            document.body.appendChild(bienvenida);

            setTimeout(() => {
                bienvenida.style.opacity = '0';
                bienvenida.style.transition = 'opacity 0.5s';
                setTimeout(() => {
                    if (bienvenida.parentNode) {
                        bienvenida.parentNode.removeChild(bienvenida);
                    }
                }, 500);
            }, 3000);
        });

        // Manejar visibilidad de la p√°gina (pausar cuando no est√° visible)
        document.addEventListener('visibilitychange', function() {
            if (document.hidden && !juegoTerminado && !juegoPausado) {
                pausarJuego();
            }
        });

        // Prevenir cierre accidental de la p√°gina durante el juego
        window.addEventListener('beforeunload', function(event) {
            if (!juegoTerminado && (paresEncontrados > 0 || intentos > 0)) {
                event.preventDefault();
                event.returnValue = '¬øEst√°s seguro de que quieres salir? Se perder√° el progreso del juego.';
                return event.returnValue;
            }
        });

    </script>
</body>
</html>